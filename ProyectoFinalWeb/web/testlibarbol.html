<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <meta charset="UTF-8">
        <title></title>
        <link rel="stylesheet" href="css/joint.css" />
        <link rel="stylesheet" href="css/arbol.css" />
        <link rel="stylesheet" href="css/compuerta.css" />
        <script>
            var graph;
            var veces=0;
            </script>
        <script src="js/joint.js"></script>
        <script src="js/joint.shapes.arbol.js"></script>
        <script src="js/arbollogica.js"></script>
        <script>

            $(document).ready(function() {

                //alert($(".inputEvento").val());

            });

            var eT=new ARBOL.EventoTope();
            $(document).ready(function () {


                var e1=new ARBOL.Evento("","Evento1");
                var e2=new ARBOL.Evento("","Evento2");

                var compuerta1=new ARBOL.Compuerta("","OR");
                compuerta1.setHijoEvento(e1);
                e1.setValor(0.3);
                e2.setValor(2);
                compuerta1.setHijoEvento(e2);
                e2.setValor(0.1);
                //e1.suscribir(compuerta1);           
                console.log(compuerta1.hasHijoEvento(e1));
               
                console.log("compuerta 1 "+compuerta1.getTipo());
                console.log(compuerta1.getValorCompuerta(compuerta1));
                console.log(compuerta1.hasHijoEvento(e2));
                /*
                var e3=new ARBOL.Evento("","Evento3");
                e3.setValor(0.1);
                var compuerta2=new ARBOL.Compuerta("","AND");
                compuerta2.setHijoEvento(e3);
                console.log(compuerta2.getValorCompuerta(compuerta2));
                
                compuerta2.setHijoCompuerta(compuerta1);
                console.log("compuerta 2",compuerta2.getValorCompuerta(compuerta2));
                
                var eventoTope=new ARBOL.EventoTope('tope1','Evento Tope 1');
                eventoTope.setHijo(compuerta2);
                console.log(eventoTope.getHijo());
                
                eventoTope.setValor(eventoTope.getHijo().getValorCompuerta(eventoTope.getHijo()));
                console.log("El valor es:"+eventoTope.getValor());
                //console.log("El valor es:"+eventoTope.getValor());
                e3.setValor(0.3);
                //
                //eventoTope.setValor(eventoTope.getHijo().getValorCompuerta(eventoTope.getHijo()));
                console.log("El valor es:"+eventoTope.getValor());
                //console.log("El valor es:"+eventoTope.getValor());
                
                
                
                */







                graph = new joint.dia.Graph;
                /*graph.on('change', function(link){
                   console.log("En evento graph on",link);                    
                }
                );*/
                var paper = new joint.dia.Paper(
                {
                    el: $('#paper'),
                    width: 1100,
                    height: 600,
                    gridSize: 1,
                    model: graph,
                    defaultLink:new joint.shapes.arbol.Link,
                    snapLinks: true,
                    linkPinning: false,                    
                    restrictTranslate:{x: 0, y: 0, width: 1100, height:600},
                    validateConnection: function(vs, ms, vt, mt, e, vl) {
                       if(vs!=vt)
                       {
                    if (e === 'target') {
                        console.log("port source",vs);
                        console.log("port source");
                        console.log("vt",vt);
                        console.log("vs",vs);
                        var puertoOrigen=V(ms || !ms.getAttribute('class') || mt.getAttribute('class').indexOf('output')).attr('port').slice(0,3);
                        console.log("tipo de puerto origen",puertoOrigen);                        
                        if(ms!=mt){
                            //var source = graph.getCell();
                            //source.attr('.outPorts circle/magnet', 'passive')
                        if(puertoOrigen=='out')
                        {
                            console.log("out a in",vt,vs);                               
                                if(((typeof vt.model.Evento)!='undefined')&&((typeof vs.model.Compuerta)!='undefined')){ //cuando se une de out compuerta -> in Evento
                                    if(!(vt.model.Evento.hasHijoCompuerta(vs.model.Compuerta))){
                                        vt.model.Evento.setHijo(vs.model.Compuerta);
                                        console.log("Agregado Compuerta",vt.model.Evento.getHijo());
                                       // alert("Se agrego la compuerta como hijo de Evento");
                                        return true;
                                    }
                             }else if(((typeof vs.model.Evento)!='undefined')&&((typeof vt.model.Compuerta)!='undefined')){ //se une out Evento-> int Compuerta
                                        if(!(vt.model.Compuerta.hasHijoEvento(vs.model.Evento))){
                                            vt.model.Compuerta.setHijoEvento(vs.model.Evento);
                                            console.log("Agregado Evento",vt.model.Compuerta.getTipo(),vt.model.Compuerta.getValor());
                                            return true;
                                        }else
                                             console.log("Lo tengo como hijo");
                                        console.log("Compuerta",vt.model.Compuerta,"Compuerta \n",vt.model.Compuerta.hasHijoEvento(vs.model.Evento));
                                    }
                             
                            
                            
                            /*if(typeof vs.model.Evento!='undefined'&&typeof vt.model.Compuerta!='undefined'){
                                    if(!(vs.model.Evento.hasHijoCompuerta(vt.model.Compuerta))){
                                        console.log("Agregando Hijo compuerta!!");
                                        vs.model.Evento.setHijo(vt.model.Compuerta);
                                    }
                                    console.log("Evento",vs.model.Evento,"Evento \n",vs.model.Evento.hasHijoCompuerta(vt.model.Compuerta));
                                }*/
                        }else if(puertoOrigen=='in')
                        {
                            console.log("in a out");                                                        
                        }
                    }
                        //console.log("test",typeof vs.model.Evento!='undefined',typeof vt.model.Compuerta!='undefined',vs.model.Evento.hasHijoCompuerta(vt.model.Compuerta));
                        // target requires an input port to connect
                         
                         /*
                        
                        
                        
                          }
                        */
                        /*if (!mt || !mt.getAttribute('class') || mt.getAttribute('class').indexOf('input') < 0) 
                            return false;*/
                        
                       

                        } else { // e === 'source'
                            console.log("es source");
                            // source requires an output port to connect
                            /*return ms && ms.getAttribute('class') && ms.getAttribute('class').indexOf('output') >= 0; */
                        }
                      }
                     return true;
                    }
             });
             paper.on("cell:highlight",function(cellView, el){
                 console.log("aqui en paper",cellView,el);
                 
                 
             });

/*here*/
                /*
                 * To change this license header, choose License Headers in Project Properties.
                 * To change this template file, choose Tools | Templates
                 * and open the template in the editor.
                 */

               /* var connect = function (source, sourcePort, target, targetPort) {
                    if(source instanceof joint.shapes.arbol.Evento && target instanceof joint.shapes.arbol.Evento ){
                            console.log("Evento no se puede unir con evento");
                    }else{
                        console.log("Entra");
                    var link = new joint.shapes.arbol.Link({
                        source: {id: source.id, selector: source.getPortSelector(sourcePort)},
                        target: {id: target.id, selector: target.getPortSelector(targetPort)}
                    });
                    link.addTo(graph).reparent();
                }
                };*/



                /*
                 eventoIniciador.el=new ARBOL.EventoIniciador;
                 console.log(eventoIniciador);
                 */


                /* Metodo para asignar ID del evento*/
                //No eliminar
               // evento.setIdModel("500ffe65-583f-4205-92b3-1545dd618d4x");


//graph.addCells([evento,cAND]);

//connect(a3,'y',a1,'a');

//connect(c1,'in',a1,'xy');

                /* rounded corners */
                /*
                 _.each([c1,a1,a2,a3,a4,cAND], function(element) {
                 element.attr({ '.body': { 'rx': 6, 'ry': 6 }});
                 });
                 */

                /* custom highlighting */

                var highlighter = V('circle', {
                    'r': 14,
                    'stroke': '#ff7e5d',
                    'stroke-width': '6px',
                    'fill': 'transparent',
                    'pointer-events': 'none'
                });

                paper.off('cell:highlight cell:unhighlight').on({
                    'cell:highlight': function (cellView, el, opt) {

                        if (opt.embedding) {
                            V(el).addClass('highlighted-parent');
                        }

                        if (opt.connecting) {
                            var bbox = V(el).bbox(false, paper.viewport);
                            highlighter.translate(bbox.x + 10, bbox.y + 10, {absolute: true});
                            V(paper.viewport).append(highlighter);
                        }
                    },
                    'cell:unhighlight': function (cellView, el, opt) {

                        if (opt.embedding) {
                            V(el).removeClass('highlighted-parent');
                        }

                        if (opt.connecting) {
                            highlighter.remove();
                        }
                    }
                });

                //Llamada a evento tope
                $("#eventoTope").click(function (evt) {

                    var eventoIniciador = new joint.shapes.arbol.Evento({
                        position: {x: 920, y: 30},
                        size: {width: 170, height: 100},
                        label: 'I am HTML',
                        inPorts: ['in'],
                    });


                    graph.addCells([eventoIniciador]);

                }); //FIN compuertaTope

                  //Llamada a evento
                  $("#evento").click(function (evt) {
                  var evento = new joint.shapes.arbol.Evento({
                        position: {x: 920, y: 30},
                        size: {width: 170, height: 100},
                        label: 'I am HTML',
                        inPorts: ['in'],
                        outPorts: ['out']
                    });
                    evento.Evento=new ARBOL.Evento(evento.id,'Evento 1');                                        
                    console.log(evento);
                    graph.addCells([evento]);
                    }); //Fin compuerta evento


                 //Llamada a compuerta And
                $("#compuertaAnd").click(function (evt) {

                    var cAND = new joint.shapes.arbol.CompuertaAND({
                    position: {x: 1000, y: 40},
                    size: {width: 48, height: 48},
                    inPorts: [""],
                    outPorts: [""]
                });
                cAND.Compuerta=new ARBOL.Compuerta(cAND.id,'AND');
                graph.addCells([cAND]);
                console.log(cAND);
                }); //FIN compuertaAnd


                //Llamada a compuerta Or
                $("#compuertaOr").click(function (evt)
                {
                     var cOr = new joint.shapes.arbol.CompuertaOR({
                    position: {x: 1000, y: 40},
                    size: {width: 48, height: 48},
                    inPorts: [""],
                    outPorts: [""]
                });
                    cOr.Compuerta=new ARBOL.Compuerta(cOr.id,'OR');
                    graph.addCells([cOr]);

                }); //FIN compuertaOr

               //Llamada a compuerta Or Exclusiva
                $("#compuertaOrEx").click(function (evt)
                {
                    var cOrExclusiva = new joint.shapes.arbol.CompuertaOREX({
                    position: {x: 1000, y: 40},
                    size: {width: 48, height: 48},
                    inPorts: [""],
                    outPorts: [""]
                });
                    graph.addCells([cOrExclusiva]);

                }); //FIN compuertaOr

                //Llamada a compuerta AND Prioritaria
                $("#compuertaAndPri").click(function (evt)
                {
                    var cAndPrioritaria = new joint.shapes.arbol.CompuertaANDPRI({
                    position: {x: 1000, y: 40},
                    size: {width: 48, height: 48},
                    inPorts: [""],
                    outPorts: [""]
                });
                    graph.addCells([cAndPrioritaria]);

                }); //FIN compuertaAND Prioritaria
                
                
                /*Funcion para mostrar el resultado de conectar los puertos entrada/salida
                CLIO
                16092015 1828
                */
                function out(m) 
                {
                    $('#paper-link-out').html(m);
                }//Fin out, CLIO


            }); //FIN DE READY


        </script>
    </head>
    <body>
        <table border="1">
            <tr>
                <td rowspan="7">
                    <div id="paper" >

                    </div>
                </td>
            </tr>

            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="eventoTope" value="Evento tope" />
                </td>
            </tr>
             <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="evento" value="Evento" />
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="compuertaAnd" value="AND" />
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="compuertaOr" value="OR" />
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="compuertaOrEx" value="OR EX."/>
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="compuertaAndPri" value="AND PRI." />
                </td>
            </tr>
        </table>
 <!--Mostrar conexiones validas,CLIO, 16092015 1830-->
        <div id="paper-link-out"></div>

    </body>
</html>
