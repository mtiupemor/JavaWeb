<html>
    <head>
        <meta charset="UTF-8">
        <title></title>
        <link rel="stylesheet" href="css/joint.css" />
        <link rel="stylesheet" href="css/arbol.css" />
        <link rel="stylesheet" href="css/compuerta.css" />
        <link rel="stylesheet" href="css/logic.css" />
        <script src="js/joint.js"></script>                
        <script src="js/joint.shapes.arbol.js"></script>
       
        <script src="js/joint.shapes.logic.js"></script>
        <script src="js/joint.shapes.logic.min.js"></script>
        <script>
            var lon =200;
            var lat =400;
            var eventoIniciador;
            var idSistema="";
            var idExito="";
            var id1="";
            var sistema;
            var exito;
            var position;
           $(document).ready(function () {

                var graph = new joint.dia.Graph;

                var paper = new joint.dia.Paper({
                    el: $('#paper'),
                    width: 1200,
                    height: 1000,
                    gridSize: 1,
                    model: graph,
                    snapLinks: true,
                    embeddingMode: true,
                    defaultLink: new joint.shapes.logic.Wire,
                    validateEmbedding: function (childView, parentView) {
                        return false;//parentView.model instanceof joint.shapes.arbol.Coupled;
                    },
                    validateConnection: function (sourceView, sourceMagnet, targetView, targetMagnet) {
                        return sourceMagnet != targetMagnet;
                    }
                });
                
                var Inicio = new joint.shapes.basic.Rect({
                position: { x: 20, y: 50 },
                size: { width: 100, height: 30 },
                attrs: { rect: { fill: '#E74C3C' }, text: { text: 'Loca grande' } }
                });
                
                var r1 = new joint.shapes.basic.Rect({
                position: { x: 150, y: 20 },
                size: { width: 100, height: 30 },
                attrs: { rect: { fill: '#E74C3C' }, text: { text: 'Apagado del\n reactor' } }
                });
                
                var r2 = r1.clone();
                r2.translate(150);
                
                
                var r3 = r2.clone();
                r3.translate(150);
                
                var r4 = r3.clone();
                r4.translate(150);
                
                var r5 = r4.clone();
                r5.translate(150);
                
                var r6 = r5.clone();
                r6.translate(150);
                 
                graph.addCells([Inicio, r1, r2, r3, r4, r5, r6]);
      
                //Llamada a evento iniciador
                $("#eventoIniciador").click(function (evt) {

                    eventoIniciador = new joint.shapes.arbol.EventoIniciador({
                        position: {x: 20, y: 300},
                        size: {width: 100, height: 40},
                        label: 'I am HTML',
                        inPorts: ['in']
                    });
                    graph.addCells([eventoIniciador]);
                }); //FIN evento iniciador
                
  
               
                  //Llamada a sistema
                $("#sistema").click(function (evt) {
                  sistema = new joint.shapes.arbol.Sistema({
                        position: {x: lon, y: lat},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                  position = sistema.get('position');//Obtiene la posici√≥n del sistema creado
                  graph.addCells([sistema]);
                  crearExito(lon,position.y-100); //Crea un elemento exito 100 pixeles arriba del sistema
                  sistema.embed(exito); //Lo agrega como hijo del sistema creado
                  conectar(sistema,'in',exito,'in');
                  lon+=150;  //Desplazamiento de x
                  lat+=100;
                  if (document.getElementById("rbtFalla").checked)
                  {
                    //alert("Es falla");
                    
                    if(graph.getCell(idSistema)!=null){
                        graph.getCell(idSistema).embed(sistema);//Agrega el nuevo sistema como hijo del sistema anterior
                        conectar(graph.getCell(idSistema),'in',sistema,'in');
                        //connectar(graph.getCell(sistema.get('parent')),'in',sistema,'in');
                    }else{
                        idSistema = sistema.get('id'); //Obtiene el id del primer sistema
                        conectar(eventoIniciador,'in',sistema,'in')//se conecta el evento iniciador con el primer sistema
                    }
                    idSistema=sistema.get('id'); //Obtiene el id del nuevo sistema
                    }else{
                      alert("Es exito");
                      if(graph.getCell(idSistema)!=null){
                        graph.getCell(idSistema).embed(sistema);//Agrega el nuevo sistema como hijo del sistema anterior
                        conectar(graph.getCell(idSistema),'in',sistema,'in');
                        //connectar(graph.getCell(sistema.get('parent')),'in',sistema,'in');
                      }else{
                            idSistema = sistema.get('id'); //Obtiene el id del primer sistema
                            conectar(eventoIniciador,'in',sistema,'in')//se conecta el evento iniciador con el primer sistema
                      }
                      idSistema=sistema.get('id'); //Obtiene el id del nuevo sistema
                    }else{
                    }
                  
                  
                }); //Fin sistema
                    
                  //Llamada a exito  
                $("#exito").click(function (evt) {
                  crearExito(100,100);
                  
                }); 
                function crearExito(lon1,lat1){
                    exito = new joint.shapes.arbol.Exito({
                        position: {x: lon1, y: (lat1)},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                    graph.addCells([exito]);
                    console.log(exito);
      
                }
                //Fin exito
                //Funcion conectar
                var conectar = function(source, sourcePort, target, targetPort) {
                    console.log("endConectar");
                      console.log(source);
                       console.log(target);
                var link = new joint.shapes.logic.Wire({
                source: { id: source.id, selector: source.getPortSelector(sourcePort) },
                target: { id: target.id, selector: target.getPortSelector(targetPort) }
                });
                link.addTo(graph).reparent();
                };
                //Termna funcion conectar
                
                 //Llamada a una frecuencia 
                $("#frecuencia").click(function (evt) {
                  var frecuencia = new joint.shapes.arbol.Frecuencia({
                        position: {x: 30, y: 80},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                  graph.addCells([frecuencia]);
                }); //Fin frecuencia
                    
            }); //FIN DE READY
        </script>
    </head>
    <body>
        <form id="eventos">

            <table border="1">
            <tr>
                <td rowspan="7">
                    <div id="paper" >

                    </div>
                </td>
            </tr>

            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="eventoIniciador" value="Evento iniciador" />
                </td>
            </tr>
             <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="sistema" value="Sistema" />
                    <br>
                    <input id="rbtFalla" type="radio" name="sistema" value="falla" checked>Falla
                    
                    <input id="rbtExito" type="radio" name="sistema" value="exito">exito
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="exito" value="Exito" />
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="frecuencia" value="Frecuencia" />
                </td>
            </tr>
        </table>
       </form>

    </body>
</html>
