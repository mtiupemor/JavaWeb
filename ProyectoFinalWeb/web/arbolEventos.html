<html>
    <head>
        <meta charset="UTF-8">
        <title></title>
        <link rel="stylesheet" href="css/joint.css" />
        <link rel="stylesheet" href="css/arbolEventos.css" />
        <link rel="stylesheet" href="css/compuerta.css" />
        <link rel="stylesheet" href="css/logic.css" />
        <script src="js/joint.js"></script>                
        <script src="js/joint.shapes.arbolEventos.js"></script>
       
        <script src="js/joint.shapes.logic.js"></script>
        <script src="js/joint.shapes.logic.min.js"></script>
        <script>
            var lon =200;
            var lat =400;
            var eventoIniciador;
            var idSistema="";
            var idExito="";
            var id1="";
            var sistema;
            var exito;
            var xySistema;
            var xyExito;
            var exitosNull=[]; //Almacena los exitos que han quedado nulos
            var sistemasNull=[];//Almacena los sistemas que han quedado nulos
           $(document).ready(function () {

                var graph = new joint.dia.Graph;

                var paper = new joint.dia.Paper({
                    el: $('#paper'),
                    width: 1200,
                    height: 1000,
                    gridSize: 1,
                    model: graph,
                    snapLinks: true,
                    embeddingMode: true,
                    defaultLink: new joint.shapes.logic.Wire,
                    validateEmbedding: function (childView, parentView) {
                        return false;//parentView.model instanceof joint.shapes.arbol.Coupled;
                    },
                    validateConnection: function (sourceView, sourceMagnet, targetView, targetMagnet) {
                        return sourceMagnet != targetMagnet;
                    }
                });
                
                var Inicio = new joint.shapes.basic.Rect({
                position: { x: 20, y: 50 },
                size: { width: 100, height: 30 },
                attrs: { rect: { fill: '#E74C3C' }, text: { text: 'Loca grande' } }
                });
                
                var r1 = new joint.shapes.basic.Rect({
                position: { x: 150, y: 20 },
                size: { width: 100, height: 30 },
                attrs: { rect: { fill: '#E74C3C' }, text: { text: 'Apagado del\n reactor' } }
                });
                
                var r2 = r1.clone();
                r2.translate(150);
                
                
                var r3 = r2.clone();
                r3.translate(150);
                
                var r4 = r3.clone();
                r4.translate(150);
                
                var r5 = r4.clone();
                r5.translate(150);
                
                var r6 = r5.clone();
                r6.translate(150);
                 
                graph.addCells([Inicio, r1, r2, r3, r4, r5, r6]);
      
                //Llamada a evento iniciador
                $("#eventoIniciador").click(function (evt) {

                    eventoIniciador = new joint.shapes.arbolEventos.EventoIniciador({
                        position: {x: 20, y: 300},
                        size: {width: 100, height: 40},
                        label: 'I am HTML',
                        inPorts: ['in']
                    });
                    graph.addCells([eventoIniciador]);
                }); //FIN evento iniciador
                
  
               
                  //Llamada a sistema
                
                $("#sistema").click(function (evt) {
                          
                  if (document.getElementById("rbtFalla").checked)
                  {
                    
                        
                        if(graph.getCell(idSistema)!=null){
                            lon=xySistema.x+150;  //Desplazamiento de x
                            lat=xySistema.y+100;  
                            crearSistema();
                            //graph.getCell(idSistema).embed(sistema);//Agrega el nuevo sistema como hijo del sistema anterior
                            conectar(graph.getCell(idSistema),'in',sistema,'in');
                            exitosNull.push(idExito); //Se agrega el sistema anterior porque queda nulo
                        }else{
                            crearSistema();
                            id1 = sistema.get('id'); //Obtiene el id del primer sistema
                            conectar(eventoIniciador,'in',sistema,'in')//se conecta el evento iniciador con el primer sistema
                            //idExito = exito.get('id'); //Obtiene el id del nuevo exito
                            //exitosNull.push(idExito); //Se agrega el sistema anterior porque queda nulo
                        }
                        
                  }else{
                        
                        if(graph.getCell(idSistema)!=null){
                          lon=xyExito.x+150;
                          lat=xyExito.y;
                          crearSistema();
                          //graph.getCell(idExito).embed(sistema);//Agrega el nuevo sistema como hijo del sistema anterior
                          conectar(graph.getCell(idExito),'in',sistema,'in');
                          sistemasNull.push(idSistema); //Se agrega el exito anterior porque ha quedado nulo
                        }else{
                            alert("Agrega primero un sistema");
                            //idSistema = sistema.get('id'); //Obtiene el id del primer sistema
                            //conectar(eventoIniciador,'in',sistema,'in')//se conecta el evento iniciador con el primer sistema

                        }
                        
                  }
                  idSistema=sistema.get('id'); //Obtiene el id del nuevo sistema
                  idExito = exito.get('id'); //Obtiene el id del nuevo exito
                
                }); //Fin sistema
                    
                  //Llamada a exito  
                $("#exito").click(function (evt) {
                  var exitoFin = new joint.shapes.arbolEventos.Exito({
                        position: {x: lon1, y: (lat1)},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                    exitoFin.type="exitoFin"; 
                    graph.addCells([exitoFin]);
                  
                });
                function crearSistema(){
                    sistema = new joint.shapes.arbolEventos.Sistema({
                        position: {x: lon, y: lat},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                    sistema.type="sistema";
                    xySistema = sistema.get('position');//Obtiene la posiciÃ³n del sistema creado
                    graph.addCells([sistema]);
                    crearExito(xySistema.x,xySistema.y-100); //Crea un elemento exito 100 pixeles arriba del sistema
                    xyExito = exito.get('position');
                    //sistema.embed(exito); //Lo agrega como hijo del sistema creado
                    conectar(sistema,'in',exito,'in');
                    
                }
                function crearExito(lon1,lat1){
                    exito = new joint.shapes.arbolEventos.Exito({
                        position: {x: lon1, y: (lat1)},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                    exito.type="exito"; 
                    graph.addCells([exito]);
      
                }
                function calcularXY(lon1,lat1){
                    exito = new joint.shapes.arbolEventos.Exito({
                        position: {x: lon1, y: (lat1)},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                    graph.addCells([exito]);
    
                }
                //Fin exito
                //Funcion conectar
                var conectar = function(source, sourcePort, target, targetPort) {
                var link = new joint.shapes.logic.Wire({
                source: { id: source.id, selector: source.getPortSelector(sourcePort) },
                target: { id: target.id, selector: target.getPortSelector(targetPort) }
                });
                link.addTo(graph).reparent();
                };
                //Termna funcion conectar
                
                 //Llamada a una frecuencia 
                $("#frecuencia").click(function (evt) {
                  var frecuencia = new joint.shapes.arbolEventos.Frecuencia({
                        position: {x: 30, y: 80},
                        size: {width: 100, height: 40},
                        inPorts: ['in']
                    });
                  graph.addCells([frecuencia]);
                }); //Fin frecuencia
                
                graph.on('add', function(sistema) { 
                                    
                if(sistema.type==="exito"){
                    var cont =0;
                    console.log("Nuevo exito y: ",graph.getCell(sistema.id).get('position').y)
                    var yExito = graph.getCell(sistema.id).get('position').y; //Se obtiene valor y del nuevo elemento exito
                    for (var cont = exitosNull.length - 1; cont >= 0 ; cont--){
                        console.log(cont," exito y: ",graph.getCell(exitosNull[cont]).get('position').y);
                        if( yExito <= graph.getCell(exitosNull[cont]).get('position').y){
                            yExito= graph.getCell(exitosNull[cont]).get('position').y - yExito + 100;
                            graph.getCell(exitosNull[cont]).translate(0,-yExito);
                            yExito = graph.getCell(exitosNull[cont]).get('position').y;
                        }
                        console.log(cont," exito nuevo y: ",graph.getCell(exitosNull[cont]).get('position').y);
                }
                }
                if(sistema.type==="sistema"){
                    var cont =0;
                    console.log("Nuevo sistema y: ",graph.getCell(sistema.id).get('position').y)
                    var ySistema=graph.getCell(sistema.id).get('position').y;
                    for (var cont = sistemasNull.length - 1; cont >= 0 ; cont--){
                        console.log(cont," sistema y: ",graph.getCell(sistemasNull[cont]).get('position').y);
                        if( ySistema >= graph.getCell(sistemasNull[cont]).get('position').y){
                            ySistema= ySistema - graph.getCell(sistemasNull[cont]).get('position').y + 100;
                            graph.getCell(sistemasNull[cont]).translate(0,ySistema);
                            ySistema = graph.getCell(sistemasNull[cont]).get('position').y;
                        }
                        console.log(cont," sistema nuevo y: ",graph.getCell(sistemasNull[cont]).get('position').y);
                }
                }
                });
                
                    
            }); //FIN DE READY
        </script>
    </head>
    <body>
        <form id="eventos">

            <table border="1">
            <tr>
                <td rowspan="7">
                    <div id="paper" >

                    </div>
                </td>
            </tr>

            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="eventoIniciador" value="Evento iniciador" />
                </td>
            </tr>
             <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="sistema" value="Sistema" />
                    <br>
                    <input id="rbtFalla" type="radio" name="sistema" value="falla" checked>Falla
                    
                    <input id="rbtExito" type="radio" name="sistema" value="exito">exito
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="exito" value="Exito" />
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="frecuencia" value="Frecuencia" />
                </td>
            </tr>
            <tr>
                <td width="250" align="CENTER">
                    <input type="button" id="calcular" value="Calcular" />
                </td>
            </tr>
        </table>
       </form>

    </body>
</html>
